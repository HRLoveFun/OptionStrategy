
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Observation Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <header>
        <h1>Market Observation Dashboard</h1>
        <p class="subtitle">Advanced Market Analysis & Options Strategy Tool</p>
    </header>

    <!-- Parameter Bar: Clear structure for input -->
    <div class="parameter-bar">
        <form method="post" id="analysis-form" class="parameter-form">
            {% if error %}
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <span>{{ error }}</span>
            </div>
            {% endif %}

            <div class="parameter-grid">
                <!-- Ticker, Horizon, Frequency, Risk, Bias, Submit -->
                <div class="form-group">
                    <label for="ticker">Ticker</label>
                    <input type="text" id="ticker" name="ticker" value="{{ ticker or '' }}" 
                           placeholder="AAPL, ^GSPC" required>
                    <div class="ticker-validation" id="ticker-validation"></div>
                </div>

                <div class="form-group">
                    <label for="start_time">Horizon</label>
                    <div class="horizon-fields">
                        <input type="month" id="start_time" name="start_time"
                               value="{{ (start_time[:4] + '-' + start_time[4:6]) if start_time and start_time|length == 6 else start_time or '' }}"
                               placeholder="Start YYYY-MM" required>
                        <span class="to-separator">to</span>
                        <input type="month" id="end_time" name="end_time"
                               value="{{ (end_time[:4] + '-' + end_time[4:6]) if end_time and end_time|length == 6 else end_time or '' }}"
                               placeholder="End YYYY-MM (optional)">
                    </div>
                    <div class="hint" id="horizon-hint">Enter months as YYYY-MM. End month is optional; defaults to latest if left blank.</div>
                    <div class="validation-warning" id="horizon-warning" style="display:none;"></div>
                </div>

                <div class="form-group">
                    <label for="frequency">Frequency</label>
                    <select id="frequency" name="frequency">
                        <option value="D" {% if frequency == 'D' %}selected{% endif %}>Daily</option>
                        <option value="W" {% if frequency == 'W' %}selected{% endif %}>Weekly</option>
                        <option value="ME" {% if frequency == 'ME' or not frequency %}selected{% endif %}>Monthly</option>
                        <option value="QE" {% if frequency == 'QE' %}selected{% endif %}>Quarterly</option>
                    </select>
                </div>

                

                <div class="form-group">
                    <label for="risk_threshold">Risk Threshold (%)</label>
                    <input type="number" id="risk_threshold" name="risk_threshold" 
                           min="0" max="100" step="1" value="{{ risk_threshold or 90 }}" required>
                </div>

                <div class="form-group">
                    <label for="side_bias">Side Bias</label>
                    <select id="side_bias" name="side_bias">
                        <option value="Natural" {% if side_bias == 'Natural' %}selected{% endif %}>Natural</option>
                        <option value="Neutral" {% if side_bias == 'Neutral' %}selected{% endif %}>Neutral</option>
                    </select>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-play"></i> Analyze
                    </button>
                </div>
            </div>
            <input type="hidden" id="option_position" name="option_position">
        </form>
    </div>

    <!-- Options Strategy Section: Collapsible for clarity -->
    <div class="options-toggle-section">
        <div class="toggle-header" onclick="toggleOptionsSection()">
            <h3>Positions (Optional)</h3>
            <div class="toggle-controls">
                <i class="fas fa-chevron-down toggle-icon" id="options-toggle-icon"></i>
            </div>
        </div>

        <div class="options-content" id="options-content">
            <div class="options-table-container">
                <table id="options-table" class="options-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Strike</th>
                            <th>Quantity</th>
                            <th>Premium</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="options-tbody">
                        <!-- Rows added by JS -->
                    </tbody>
                </table>
                <div class="add-row-container">
                    <button type="button" class="btn-add-row" onclick="addOptionRow()">
                        <i class="fas fa-plus"></i> Add Position
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content: Results and Analysis -->
    <main class="main-content">
        {% if ticker %}
        <section class="results-section">
            <div class="results-header">
                <h2>Analysis Results for {{ ticker }}</h2>
                <div class="results-meta">
                    <span class="meta-item">
                        Frequency: {{ frequency_display or frequency }}
                    </span>
                    <span class="meta-item">
                        Feature: Oscillation Analysis
                    </span>
                    <span class="meta-item">
                        Horizon: {{ start_time or '' }}{% if end_time %} → {{ end_time }}{% else %} → latest{% endif %}
                    </span>
                    <span class="meta-item">
                        Risk Threshold: {{ risk_threshold or 90 }}%
                    </span>
                    <span class="meta-item">
                        Bias: {{ side_bias or 'Natural' }}
                    </span>
                </div>
            </div>

            <!-- Market Review Section -->
            <div class="market-review-section">
                <h3>Market Review</h3>
                
                <div class="market-review-grid">
                    {% if market_review_table %}
                    <div class="stats-container full-width">
                        <h4>Return, Volatility, and Correlation</h4>
                        <div class="table-wrapper">
                            {{ market_review_table|safe }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Statistical Analysis Section -->
            <div class="analysis-section">
                <h3>Statistical Analysis</h3>
                
                <div class="charts-vertical">
                    {% if feat_ret_scatter_top_url or feat_ret_scatter_hist_url %}
                    <div class="chart-container">
                        <h4>Oscillation vs Returns Correlation</h4>
                        <div class="chart-wrapper">
                            <img src="data:image/png;base64,{{ feat_ret_scatter_top_url or feat_ret_scatter_hist_url }}" 
                                 alt="Oscillation vs Returns Analysis (Top)" class="analysis-chart">
                        </div>
                    </div>
                    {% endif %}

                    {% if feat_ret_scatter_bottom_url %}
                    <div class="chart-container">
                        <h4>Oscillation-Returns Dynamics</h4>
                        <div class="chart-wrapper">
                            <img src="data:image/png;base64,{{ feat_ret_scatter_bottom_url }}" 
                                 alt="Oscillation-Returns Dynamics Line Chart" class="analysis-chart">
                        </div>
                    </div>
                    {% endif %}

                    {% if feat_ret_spread_url %}
                    <div class="chart-container">
                        <h4>Oscillation-Returns Spread Dynamics</h4>
                        <div class="chart-wrapper">
                            <img src="data:image/png;base64,{{ feat_ret_spread_url }}" 
                                 alt="Oscillation-Returns Spread Bar Chart" class="analysis-chart">
                        </div>
                    </div>
                    {% endif %}

                    {% if volatility_dynamic_url %}
                    <div class="chart-container">
                        <h4>Volatility Dynamics</h4>
                        <div class="chart-wrapper">
                            <img src="data:image/png;base64,{{ volatility_dynamic_url }}" 
                                 alt="Volatility Dynamics" class="analysis-chart">
                        </div>
                    </div>
                    {% endif %}
                </div>

                
            </div>

            <!-- Market Assessment Section -->
            <div class="assessment-section">
                <h3>Market Assessment & Projections</h3>
                
                <div class="charts-grid">
                    {% if feat_projection_url %}
                    <div class="chart-container full-width">
                        <h4>Oscillation Projection ({{ side_bias or 'Natural' }} Bias, {{ risk_threshold or 90 }}% Threshold)</h4>
                        <div class="chart-wrapper">
                            <img src="data:image/png;base64,{{ feat_projection_url }}" 
                                 alt="Market Projection" class="analysis-chart">
                        </div>
                    </div>
                    {% endif %}

                    {% if not feat_projection_table.empty %}
                    <div class="stats-container full-width">
                        <h4>Oscillation Projection Values</h4>
                        <div class="table-wrapper">
                            {{ feat_projection_table|safe }}
                        </div>
                    </div>
                    {% endif %}

                    {% if plot_url %}
                    <div class="chart-container full-width">
                        <h4>Options Portfolio P&L Analysis</h4>
                        <div class="chart-wrapper">
                            <img src="data:image/png;base64,{{ plot_url }}" 
                                 alt="Options P&L Chart" class="analysis-chart">
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>
        {% endif %}
    </main>

    <footer>
        <p>&copy; 2024 Market Observation Dashboard. Advanced analytics for informed trading decisions.</p>
    </footer>

    <script src="{{ url_for('static', filename='main.js') }}"></script>
</body>

</html>
